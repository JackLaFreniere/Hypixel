<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corpse ROI Calculator</title>
    <meta name="description" content="Calculate the return on investment for different corpse types in Hypixel Skyblock Glacite Tunnels">
    <link rel="stylesheet" href="../css/corpse-roi-calculator.css?v=1.0.0" type="text/css">
</head>
<body>
    <div class="header">
        <div class="header-nav">
            <a href="../index.html" class="back-button">‚Üê Back to Home</a>
        </div>
        <div class="header-content">
            <img src="../assets/Images/Items/SkyBlock_items_shattered_pendant.png" alt="Shattered Pendant" class="header-logo">
            <h1>Corpse ROI Calculator</h1>
        </div>
        <p>Calculate the return on investment for different corpse types in Hypixel Skyblock</p>
    </div>

    <div class="container">
        <!-- Corpse Selection -->
        <div class="corpse-selection">
            <h2>Select Corpse Type</h2>
            <div class="corpse-grid">
                <div class="corpse-option" data-corpse="vanguard">
                    <div class="corpse-image"></div>
                    <h3>Vanguard Corpse</h3>
                    <p>Opened with Skeleton Key</p>
                </div>
                <div class="corpse-option" data-corpse="tungsten">
                    <div class="corpse-image"></div>
                    <h3>Tungsten Corpse</h3>
                    <p>Opened with Tungsten Key</p>
                </div>
                <div class="corpse-option" data-corpse="umber">
                    <div class="corpse-image"></div>
                    <h3>Umber Corpse</h3>
                    <p>Opened with Umber Key</p>
                </div>
                <div class="corpse-option" data-corpse="lapis">
                    <div class="corpse-image"></div>
                    <h3>Lapis Corpse</h3>
                    <p>Opened for free!</p>
                </div>
            </div>

        </div>

        <!-- Results -->
        <div class="results hidden" id="results">
            <h2>ROI Analysis</h2>
            <div class="results-container">
                <div class="profit-indicator">
                    <h3><img src="../assets/Images/Items/SkyBlock_items_coin_iron.png" alt="Coin" class="profit-icon"> Profitability</h3>
                    <div class="profit-amount" id="profitAmount">+0</div>
                    <div class="profit-percentage" id="profitPercentage">0%</div>
                    <div class="profit-status" id="profitStatus">Select a corpse to calculate</div>
                </div>
                
                <div class="roi-summary">
                    <h3>Cost Breakdown</h3>
                    <div class="roi-item">
                        <span class="roi-label">Key Cost:</span>
                        <span class="roi-value" id="keyCostDisplay">0</span>
                    </div>
                    <div class="roi-item">
                        <span class="roi-label">Expected Revenue:</span>
                        <span class="roi-value" id="avgRevenueDisplay">0</span>
                    </div>
                    <div class="roi-item">
                        <span class="roi-label">Expected Profit:</span>
                        <span class="roi-value" id="expectedProfitDisplay">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drop Table -->
        <div class="drop-table">
            <h2 id="dropTableTitle">Drop Table - Select a Corpse</h2>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Loading prices...</p>
            </div>
            <div id="dropTableContainer">
                <div class="table-container">
                    <table id="dropTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="item">Item</th>
                                <th class="sortable" data-sort="quantity">Quantity</th>
                                <th class="sortable" data-sort="weight">Weight (Points)</th>
                                <th class="sortable" data-sort="weightPercent">Weight (%)</th>
                                <th class="sortable" data-sort="price">Price Each</th>
                                <th class="sortable" data-sort="total">Total Value</th>
                                <th class="sortable" data-sort="weighted">Expected Per Corpse</th>
                            </tr>
                        </thead>
                        <tbody id="dropTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="statusContainer"></div>

    <!-- Scripts -->
    <script src="../js/apis/hypixel-bazaar-api.js" charset="utf-8"
            onerror="console.error('Failed to load hypixel-bazaar-api.js'); document.body.innerHTML += '<div class=\'script-error\'>ERROR: Could not load hypixel-bazaar-api.js from ../js/apis/</div>'"></script>
    <script src="../js/apis/coflnet-auction-api.js" charset="utf-8"
            onerror="console.error('Failed to load coflnet-auction-api.js'); document.body.innerHTML += '<div class=\'script-error\'>ERROR: Could not load coflnet-auction-api.js from ../js/apis/</div>'"></script>
    <script src="../js/apis/gemstone-pricing.js" charset="utf-8"
            onerror="console.error('Failed to load gemstone-pricing.js'); document.body.innerHTML += '<div class=\'script-error\'>ERROR: Could not load gemstone-pricing.js from ../js/apis/</div>'"></script>
    <script src="../js/corpse-roi-calculator.js" charset="utf-8"
            onerror="console.error('Failed to load corpse-roi-calculator.js'); document.body.innerHTML += '<div class=\'script-error\'>ERROR: Could not load corpse-roi-calculator.js from ../js/</div>'"></script>
    <script>
        // Wait for all scripts to load
        window.addEventListener('load', function() {
            console.log('Page fully loaded, starting initialization...');
            
            // Check if all required classes are available
            console.log('Checking required classes...');
            console.log('HypixelBazaarAPI:', typeof HypixelBazaarAPI);
            console.log('CoflnetAuctionAPI:', typeof CoflnetAuctionAPI);
            console.log('GemstonePricing:', typeof GemstonePricing);
            console.log('CorpseROICalculator:', typeof CorpseROICalculator);
            
            if (typeof HypixelBazaarAPI === 'undefined') {
                console.error('HypixelBazaarAPI is not loaded!');
                document.body.innerHTML += '<div class="script-error">ERROR: HypixelBazaarAPI failed to load. Check file path.</div>';
                return;
            }
            
            if (typeof CoflnetAuctionAPI === 'undefined') {
                console.error('CoflnetAuctionAPI is not loaded!');
                document.body.innerHTML += '<div class="script-error">ERROR: CoflnetAuctionAPI failed to load. Check file path.</div>';
                return;
            }
            
            if (typeof GemstonePricing === 'undefined') {
                console.error('GemstonePricing is not loaded!');
                document.body.innerHTML += '<div class="script-error">ERROR: GemstonePricing failed to load. Check file path.</div>';
                return;
            }
            
            if (typeof CorpseROICalculator === 'undefined') {
                console.error('CorpseROICalculator is not loaded!');
                document.body.innerHTML += '<div class="script-error">ERROR: CorpseROICalculator failed to load. Check file path.</div>';
                return;
            }
            
            initializeCalculator();
        });
        
        function initializeCalculator() {
            console.log('Starting calculator initialization...');
            
            // Initialize global APIs first
            try {
                window.globalBazaarAPI = new HypixelBazaarAPI();
                window.globalCoflnetAPI = new CoflnetAuctionAPI();
                window.globalGemstonePricing = new GemstonePricing();
                console.log('Global APIs created successfully');
            } catch (error) {
                console.error('Error creating global APIs:', error);
                return;
            }
            
            // Initialize the calculator
            try {
                window.calculator = new CorpseROICalculator();
                console.log('Calculator created successfully');
                
                // Set gemstone pricing reference immediately
                if (window.globalGemstonePricing) {
                    window.calculator.setGemstonePricing(window.globalGemstonePricing);
                    console.log('Gemstone pricing reference set on calculator');
                } else {
                    console.warn('Global gemstone pricing not available yet');
                }
            } catch (error) {
                console.error('Error creating calculator:', error);
                return;
            }
            
            // Initialize the APIs
            console.log('Initializing APIs...');
            window.globalBazaarAPI.initialize().then(() => {
                console.log('Bazaar API initialized successfully');
                
                // Initialize gemstone pricing with the APIs
                window.globalGemstonePricing.initialize(window.globalBazaarAPI, window.globalCoflnetAPI);
                console.log('Gemstone pricing initialized successfully');
                
                // Re-set gemstone pricing reference after API initialization
                if (window.calculator) {
                    window.calculator.setGemstonePricing(window.globalGemstonePricing);
                    console.log('Gemstone pricing reference updated on calculator after API init');
                }
                
                // Load loot tables after API is ready
                window.calculator.loadLootTables();
            }).catch(error => {
                console.error('Failed to initialize Bazaar API:', error);
            });
            
            // Set up corpse selection with better error handling
            const corpseOptions = document.querySelectorAll('.corpse-option');
            console.log('Found corpse options:', corpseOptions.length);
            
            corpseOptions.forEach((option, index) => {
                console.log(`Setting up event listener for corpse option ${index + 1}:`, option.dataset.corpse);
                
                option.addEventListener('click', async () => {
                    try {
                        console.log('=== CORPSE CLICKED ===');
                        console.log('Corpse clicked:', option.dataset.corpse);
                        
                        // Remove selected class from all options
                        document.querySelectorAll('.corpse-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        
                        // Add selected class immediately to clicked option
                        option.classList.add('selected');
                        console.log('Visual selection updated immediately');
                        
                        // Set the corpse type (now async)
                        const corpseType = option.dataset.corpse;
                        console.log('About to call setCorpseType with:', corpseType);
                        
                        if (window.calculator && window.calculator.setCorpseType) {
                            await window.calculator.setCorpseType(corpseType);
                            console.log('setCorpseType completed');
                        } else {
                            console.error('Calculator or setCorpseType method not available');
                        }
                    } catch (error) {
                        console.error('Error in corpse click handler:', error);
                        
                        if (window.calculator && window.calculator.showStatus) {
                            window.calculator.showStatus('Error selecting corpse. Please try again.', 'error');
                        }
                    }
                });
            });
            
            console.log('Event listeners set up. Calculator ready!');
        }
        
        // Global function to show crystal prices
        async function showCrystalPrices() {
            if (!window.calculator) {
                alert('Calculator not initialized!');
                return;
            }
            
            try {
                console.log('Fetching crystal prices...');
                console.log('Calculator gemstone pricing:', window.calculator.gemstonePricing);
                console.log('Global gemstone pricing:', window.globalGemstonePricing);
                
                // Check if gemstone pricing is initialized
                if (!window.calculator.gemstonePricing) {
                    console.error('Gemstone pricing not set on calculator');
                    alert('Gemstone pricing not initialized. Please try again in a moment.');
                    return;
                }
                
                // Test individual crystal price fetch
                console.log('Testing individual amber crystal price...');
                const testPrice = await window.calculator.getCrystalPrice('amber');
                console.log('Amber crystal test price:', testPrice);
                
                const crystalPrices = await window.calculator.getAllCrystalPrices();
                console.log('All crystal prices received:', crystalPrices);
                
                let message = 'Crystal Prices:\n\n';
                let hasAnyPrices = false;
                
                for (const [gemstone, price] of Object.entries(crystalPrices)) {
                    const formattedPrice = window.calculator.formatNumber ? 
                        window.calculator.formatNumber(price) : 
                        Math.round(price).toLocaleString();
                    message += `${gemstone.charAt(0).toUpperCase() + gemstone.slice(1)} Crystal: ${formattedPrice} coins\n`;
                    if (price > 0) hasAnyPrices = true;
                }
                
                if (!hasAnyPrices) {
                    message += '\nNote: All prices showing as 0. This might indicate:\n';
                    message += '- API initialization issues\n';
                    message += '- Network connectivity problems\n';
                    message += '- Invalid item names\n';
                    message += '\nCheck browser console for detailed error logs.';
                }
                
                alert(message);
            } catch (error) {
                console.error('Error fetching crystal prices:', error);
                alert('Error fetching crystal prices: ' + error.message + '\n\nCheck browser console for more details.');
            }
        }
        
        // Test API function for debugging
        async function testAPI() {
            console.log('=== API TEST START ===');
            
            try {
                // Test bazaar API with known item
                console.log('Testing bazaar API...');
                const bazaarTest = await window.globalBazaarAPI.getItemPriceByName('FLAWED_RUBY_GEM');
                console.log('Flawed Ruby Gem price:', bazaarTest);
                
                // Test auction API with known item
                console.log('Testing auction API...');
                const auctionTest = await window.globalCoflnetAPI.getLowestBIN('PERFECT_RUBY_GEM');
                console.log('Perfect Ruby Gem price:', auctionTest);
                
                // Test crystal names
                console.log('Testing crystal item names...');
                const crystalNames = ['RUBY_CRYSTAL', 'AMBER_CRYSTAL', 'JASPER_CRYSTAL'];
                for (const name of crystalNames) {
                    const price = await window.globalCoflnetAPI.getLowestBIN(name);
                    console.log(`${name} price:`, price);
                }
                
                // Test gemstone pricing utility
                console.log('Testing gemstone pricing utility...');
                if (window.globalGemstonePricing && window.globalGemstonePricing.initialized) {
                    const rubyPrice = await window.globalGemstonePricing.getGemstonePrice('ruby', 'perfect');
                    console.log('Ruby perfect price from utility:', rubyPrice);
                    
                    const crystalPrice = await window.globalGemstonePricing.getGemstonePrice('ruby', 'crystal');
                    console.log('Ruby crystal price from utility:', crystalPrice);
                } else {
                    console.log('Gemstone pricing utility not initialized');
                }
                
                alert('API test completed. Check browser console for detailed results.');
                
            } catch (error) {
                console.error('API test error:', error);
                alert('API test failed: ' + error.message);
            }
            
            console.log('=== API TEST END ===');
        }
        
        // Set up table sorting
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('sortable')) {
                const sortBy = e.target.dataset.sort;
                if (window.calculator) {
                    window.calculator.sortTable(sortBy);
                }
            }
        });
    </script>
</body>
</html>